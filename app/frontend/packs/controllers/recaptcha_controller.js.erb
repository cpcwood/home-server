import { Controller } from 'stimulus'

export default class extends Controller {
  static targets = ['container']

  initialize () {
    if (!window.grecaptcha) {
      const reCaptchaScript = document.createElement('script')
      window.reCaptchaOnload = () => {
        window.grecaptcha.render(this.containerTarget, {
          sitekey: '<%= Rails.application.credentials.recaptcha[:site_key] %>',
          theme: 'light',
          size: 'normal'
        })
      }
      reCaptchaScript.src = 'https://www.google.com/recaptcha/api.js?onload=reCaptchaOnload&render=explicit'
      reCaptchaScript.className = 'recaptcha-script'
      document.head.appendChild(reCaptchaScript)
    } else {
      window.grecaptcha.render(this.containerTarget, {
        sitekey: '<%= Rails.application.credentials.recaptcha[:site_key] %>',
        theme: 'light',
        size: 'normal'
      })
    }
  }

  teardown() {
    if (!!window.grecaptcha) {
      window.grecaptcha.reset()
    }
    const reCaptchaScript = document.head.querySelector('.recaptcha-script')
    if (!!reCaptchaScript) {
      document.head.removeChild(reCaptchaScript)
    }
    if (!!this.containerTarget) {
      this.containerTarget.parentNode.removeChild(this.containerTarget)
    }
  }

  disconnect() {
    const reCaptchaScript = document.head.querySelector('.recaptcha-script')
    if (!!reCaptchaScript) {
      document.head.removeChild(reCaptchaScript)
    }
  }
}
